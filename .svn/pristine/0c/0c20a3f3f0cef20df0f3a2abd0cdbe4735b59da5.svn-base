using ExcelHelper;
using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Input;
using System.Windows.Media;
using System.Xml;

namespace Excel2Oracle
{
    /// <summary>
    /// MainWindow.xaml 的交互逻辑
    /// </summary>
    public partial class MainWindow : Window
    {
        public static string templatesDirectoryName = "Templates";
        public static string exeDirectory = System.IO.Path.GetDirectoryName(System.Reflection.Assembly.GetExecutingAssembly().Location);
        public static string connectInfoFileName = "ConnectInfo.xml";
        public static string templateFilePath = "";
        public static string importedFilePath = "";
        public static AnalysisHelper.ProcessReport report;
        public static AnalysisHelper.InsertProcessReport insertReport;
        public static AnalysisHelper.ProcessReportClear reportClear;
        public static AnalysisHelper.InsertProcessReportClear insertReportClear;

        List<Source> result;
        Dictionary<string, string> contentConfig;
        List<DataTable> dataTables;

        public MainWindow()
        {
            InitializeComponent();
            this.Loaded += MainLoad;
            //txtFilePath.Text = System.IO.Path.Combine(exeDirectory, @"导入文件\生产报表-大土河\燃料日报模板.xls");
        }

        private void MainLoad(object sender, RoutedEventArgs e)
        {
            this.Title = "报表数据-Oracle导入工具";
            //写进度委托加入事件
            report += WriteLineProcess;
            insertReport += WriteLineInsertProcess;
            //清理进度委托加入事件
            reportClear += ClearProcess;
            insertReportClear += ClearInsertProcess;
            //加载模板树
            TemplatesTreeViewLoad();
            //加载保存的关系库连接字符串
            DBConnectStringLoad();
        }

        private void DBConnectStringLoad()
        {
            try
            {
                string connectInfoPath = System.IO.Path.Combine(exeDirectory, connectInfoFileName);
                if (File.Exists(connectInfoPath))
                {
                    XmlDocument doc = new XmlDocument();
                    doc.Load(connectInfoPath);
                    XmlAttributeCollection attrs = doc.SelectSingleNode("Config").Attributes;
                    txtDBConnectInfo.Text = attrs["connectInfo"].Value;
                }
            }
            catch (Exception e)
            {
                MessageBox.Show("配置加载失败：" + e.Message);
            }
        }

        private void TemplatesTreeViewLoad()
        {
            string templatesPath = System.IO.Path.Combine(exeDirectory, templatesDirectoryName);
            if (!System.IO.Directory.Exists(templatesPath))
            {
                System.Windows.MessageBox.Show("未找到模板目录");
                return;
            }
            TemplateTreeViewItem[] allTreeNodes = ExcelFilesHelper.GetAllExcelFiles(templatesPath);
            TemplateTreeViewItem root = new TemplateTreeViewItem(NodeType.Root, templatesPath, allTreeNodes, "模板");
            root.Icon = "Images/templateRoot.jpg";
            root.IsExpanded = true;
            root.Visiblity = "Visible";
            TemplateTreeView.ItemsSource = new TemplateTreeViewItem[] { root };
        }

        private void TemplateTreeView_SelectedItemChanged(object sender, EventArgs e)
        {
            TemplateTreeViewItem item = (TemplateTreeViewItem)TemplateTreeView.SelectedItem;
            if (item.NodeType == NodeType.File)
            {
                lblCurTemplate.Content = item.DisplayName;
                templateFilePath = item.Path;
            }
            else
            {
                lblCurTemplate.Content = "未选择";
                templateFilePath = "";
            }
        }

        private void ReloadTemplates(object sender, RoutedEventArgs e)
        {
            TemplatesTreeViewLoad();
        }

        private void SelectImportedFile(object sender, EventArgs e)
        {
            Microsoft.Win32.OpenFileDialog ofd = new Microsoft.Win32.OpenFileDialog();
            ofd.DefaultExt = ".xls";
            ofd.Filter =
              "xls files (*.xls)|*.xls|xlsx files (*.xlsx)|*.xlsx";
            if (ofd.ShowDialog() == true)
            {
                txtFilePath.Text = ofd.FileName;
            }
        }
        /// <summary>
        /// 解析规则
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void AnalysisFile(object sender, EventArgs e)
        {
            if (templateFilePath == "")
            {
                MessageBox.Show("模板文件未选择");
                return;
            }
            if (!File.Exists(templateFilePath))
            {
                MessageBox.Show("模板文件不存在");
                return;
            }
            //解析规则
            bool success = AnalysisHelper.Analysis(templateFilePath, report, reportClear, out result, out contentConfig);
            if (success)
            {
                lblCurRule.Content = lblCurTemplate.Content;
            }
        }
        public void WriteLineProcess(string info)
        {

            txtProcess.Text = string.Format("{0}{1}{2}", txtProcess.Text, txtProcess.Text.Trim() == "" ? "" : "\r\n", info);
        }
        public void WriteLineInsertProcess(string info)
        {
            txtImportProcess.Text = string.Format("{0}{1}{2}", txtImportProcess.Text, txtImportProcess.Text.Trim() == "" ? "" : "\r\n", info);
        }
        public void ClearProcess()
        {
            txtProcess.Text = "";
        }
        public void ClearInsertProcess()
        {
            txtImportProcess.Text = "";
        }
        /// <summary>
        /// 测试关系库连接字符串
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void TestDBConnect(object sender, EventArgs e)
        {
            try
            {
                object obj = OracleHelper.ExecuteScalar(txtDBConnectInfo.Text, System.Data.CommandType.Text, "select 1 from dual");
                bool result = 1 == Convert.ToInt32(obj);
                if (result)
                {
                    MessageBox.Show("连接成功");
                }
                else
                {
                    MessageBox.Show("连接失败");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("连接失败：" + ex.ToString());
            }
        }
        /// <summary>
        /// 导入数据
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void Import(object sender, EventArgs e)
        {
            insertReportClear();
            if (dataTables == null)
            {
                insertReport("请先提取数据");
                MessageBox.Show("请先提取数据");
                return;
            }
            if (dataTables.Count == 0 || dataTables.Count(x => x.Rows.Count > 0) == 0)
            {
                insertReport("未找到任何数据");
                MessageBox.Show("未找到任何数据");
                return;
            }
            try
            {
                for (int k = 0; k < dataTables.Count; k++)
                {
                    DataTable table = dataTables[k];
                    insertReport("正在检测表"+ table);
                    if (table.Rows.Count == 0)
                    {
                        insertReport("表" + table + "不存在数据");
                        continue;
                    }
                    //获取表名
                    string tableName = table.TableName.Substring(0, table.TableName.IndexOf("(")).ToUpper();
                    //建列名
                    string createColumns = "";
                    string insertColumns = "";
                    Dictionary<string, int> colMaxLens = new Dictionary<string, int>() { };
                    List<string> willAddColumns = new List<string>();
                    for (int i = 0; i < table.Columns.Count; i++)
                    {
                        DataColumn col = table.Columns[i];
                        List<int> colMaxLen = new List<int>() { };
                        for (int j = 0; j < table.Rows.Count; j++)
                        {
                            colMaxLen.Add(table.Rows[j][i].ToString().Length);
                        }
                        int maxLen = colMaxLen.Max();
                        colMaxLens.Add(col.ColumnName, (maxLen / 50) * 50 + 50);
                    }
                    for (int i = 0; i < table.Columns.Count; i++)
                    {
                        DataColumn col = table.Columns[i];
                        if (result[k].sourceCols[i].isDate)
                        {
                            createColumns += "\"" + col.ColumnName + "\"" + " date,";
                        }
                        else
                        {
                            createColumns += "\"" + col.ColumnName + "\"" + " varchar(" + colMaxLens[col.ColumnName] + "),";
                        }
                        insertColumns += "\"" + col.ColumnName + "\",";
                    }
                    createColumns = createColumns.Remove(createColumns.Length - 1, 1);
                    insertColumns = insertColumns.Remove(insertColumns.Length - 1, 1);
                    //判断是否存在表名
                    DataTable dtCheckTablename = OracleHelper.ExecuteDataTable(txtDBConnectInfo.Text, CommandType.Text, "select table_name from user_tables where table_name='" + tableName + "'");
                    string insertSqls = "begin ";//单张表的总的插入语句
                    for (int i = 0; i < table.Rows.Count; i++)
                    {
                        string insertSql = "insert into {0}({1}) values({2});";
                        DataRow row = table.Rows[i];
                        
                        StringBuilder insertValues = new StringBuilder();
                        for (int j = 0; j < row.ItemArray.Count(); j++)
                        {
                            var item = row.ItemArray[j];
                            if (result[k].sourceCols[j].isDate)
                            {
                                insertValues.AppendFormat("to_date('{0}','{1}'),", item, result[k].sourceCols[j].dateFormat.Replace("HH","hh24").Replace("mm","mi"));
                            }
                            else
                            {
                                insertValues.AppendFormat("'{0}',", item);
                            }
                        }
                        insertValues.Remove(insertValues.Length - 1, 1);
                        insertSql = string.Format(insertSql, tableName, insertColumns, insertValues);
                        insertSqls += insertSql;
                    }
                    insertSqls += "end;";
                    if (dtCheckTablename.Rows.Count > 0) //存在该表
                    {
                        insertReport("开始导入...");
                        InsertValues(tableName, insertSqls);
                    }
                    else
                    {
                        //不存在该表 ，需要创建
                        string createTable = "create table " + tableName + string.Format("({0})", createColumns);
                        insertReport(createTable);
                        MessageBoxResult dr = MessageBox.Show("检测到表" + tableName + "不存在，是否创建该表？", "确认继续", MessageBoxButton.YesNo, MessageBoxImage.Question);
                        if (dr != MessageBoxResult.Yes)
                        {
                            return;
                        }
                        OracleHelper.ExecuteNonQuery(txtDBConnectInfo.Text, CommandType.Text, createTable);
                        insertReport("创建表" + tableName + "完毕！");
                        insertReport("开始导入...");
                        InsertValues(tableName, insertSqls);
                    }
                }
                insertReport("全部导入完成");
            }
            catch (Exception ex)
            {
                insertReport("导入失败：" + ex.ToString());
                return;
            }
        }

        private void InsertValues(string tableName,string insertSqls)
        {
            insertReport("开始导入 sql:" + insertSqls);
            int result = OracleHelper.ExecuteNonQuery(txtDBConnectInfo.Text, CommandType.Text, insertSqls);
            if (result > 0)
            {
                insertReport("表" + tableName + result + "条数据导入成功");
            }
            else
            {
                insertReport("表" + tableName + "导入失败");
            }
        }
        /// <summary>
        /// 提取数据
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void GetData(object sender, EventArgs e)
        {
            string importFilePath = txtFilePath.Text.Trim();
            if (importFilePath == "")
            {
                MessageBox.Show("导入文件未选择");
                return;
            }
            if (!File.Exists(importFilePath))
            {
                MessageBox.Show("导入文件不存在");
                return;
            }
            AnalysisHelper.GetDataByAnalysis(importFilePath, contentConfig, result, report, reportClear, out dataTables);

            spView.Children.Clear();
            foreach (DataTable table in dataTables)
            {
                Label lblTableName = new Label();
                lblTableName.Foreground = Brushes.Red;
                lblTableName.Content = table.TableName;
                ListView lv = new ListView();
                lv.HorizontalAlignment = HorizontalAlignment.Stretch;
                lv.VerticalAlignment = VerticalAlignment.Stretch;
                GridView gv = new GridView();
                foreach (DataColumn col in table.Columns)
                {
                    gv.Columns.Add(new GridViewColumn() { Header = col.ColumnName, DisplayMemberBinding = new Binding() { Path = new PropertyPath(col.ColumnName) } });
                }
                lv.View = gv;
                lv.ItemsSource = table.DefaultView;
                spView.Children.Add(lblTableName);
                spView.Children.Add(lv);
            }
            viewScroll.Content = spView;
        }
        /// <summary>
        /// 保存关系库连接字符串
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void SaveConnection(object sender, EventArgs e)
        {
            string connectInfoPath = System.IO.Path.Combine(exeDirectory, connectInfoFileName);
            File.WriteAllText(connectInfoPath, string.Format("<?xml version=\"1.0\" encoding=\"utf-8\" ?><Config  connectInfo = \"{0}\" />", txtDBConnectInfo.Text.Trim()));
            if (File.Exists(connectInfoPath))
            {
                MessageBox.Show("保存成功");
            }
        }
        /// <summary>
        /// 查看当前规则
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void ViewRules(object sender, RoutedEventArgs e)
        {
            RuleView ruleView = new RuleView(result);
            ruleView.WindowStartupLocation = WindowStartupLocation.CenterOwner;
            ruleView.ShowDialog();
        }

        private void txtFilePath_TextChanged(object sender, TextChangedEventArgs e)
        {
            txtFilePath.ToolTip = txtFilePath.Text;
            importedFilePath  = txtFilePath.Text;
        }
        /// <summary>
        /// 右击打开模板文件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void openTemplateFile_Click(object sender, RoutedEventArgs e)
        {
            OpenFile(templateFilePath);
        }
        /// <summary>
        /// 右击打开导入文件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void openImportFile_Click(object sender, RoutedEventArgs e)
        {
            OpenFile(importedFilePath);
        }
        /// <summary>
        /// 双击打开模板文件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void lblCurTemplate_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            OpenFile(templateFilePath);
        }
        /// <summary>
        /// 双击打开导入文件
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void txtFilePath_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            OpenFile(importedFilePath);
        }
        /// <summary>
        /// 右击打开模板文件目录
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void openTemplatePath_Click(object sender, RoutedEventArgs e)
        {
            OpenFilePath(templateFilePath);
        }
        /// <summary>
        /// 右击打开导入文件目录
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void openImportPath_Click(object sender, RoutedEventArgs e)
        {
            OpenFilePath(importedFilePath);
        }
        private static void OpenFile(string filePath)
        {
            if (!string.IsNullOrEmpty(filePath))
            {
                if (!File.Exists(templateFilePath))
                {
                    MessageBox.Show("文件不存在，打开失败");
                    return;
                }
                System.Diagnostics.Process.Start(filePath);
            }
        }
        private static void OpenFilePath(string filePath)
        {
            if (filePath == "")
                return;
            if (!string.IsNullOrEmpty(filePath))
            {
                if (!File.Exists(filePath))
                {
                    MessageBox.Show("文件目录不存在，打开失败");
                    return;
                }
                System.Diagnostics.Process.Start("Explorer.exe", @"/select," + filePath);
            }
        }
    }
}